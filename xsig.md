# xsig

特征码串 只接受 ANSI 字符串，要求以 *'\0'* 结尾。

1. 搜索时，先扫描最长常量串。


---- ---- ---- ----

## 注释

- 特征任意处以 `#` 号开始，直到行尾。

示例：

```
<F show_msg> # bool __stdcall show_msg(char* msg);
```

---- ---- ---- ----

## 特征点

定义如下：

```
<TAG [TAG_NAME]>
```

- 特征点以 `<` 号起始， `>` 号结束。

- `TAG` : 特征点串第一个 非空白符 为 `^` 时，表示这是一个 偏移标记。

  - 偏移标记存在时，特征点值提取结果将减去匹配块的起始地址。

- `TAG` : 特征点串第一个 非偏移标记，非空白符 **必须** 为下列字符的其中之一（无视大小写）。

    - `Q` 、 `D` 、 `W` 、 `B` 、 `A` 、 `F`

- `TAG` 与 `TAG_NAME` 之间，以 空白 分隔。

- `TAG` 详细说明如下：

    - `Q` : 表示此点是一个 QWORD ，占用 8 byte 。
    - `D` : 表示此点是一个 DWORD ，占用 4 byte 。
    - `W` : 表示此点是一个 WORD ，占用 2 byte 。
    - `B` : 表示此点是一个 BYTE ，占用 1 byte 。
    - `A` : 表示此点是一个 地址 ，占用 0 byte 。
    - `F` : 表示此点是一个 偏移 ，占用 4 byte 。无视 x86/x64 。

- `TAG_NAME` : 特征点名称。代表所在位置的 提取值。

    - 允许 `TAG_NAME` 为空。
    - 允许字符无特别限制，注意避免与关键字符冲突即可。
    - 实际应用中，避免使用复杂字符。

示例：

```
<A push_something> B8 78563412  # 定位 push 12345678 之处。
```

## 常量串

- 常量串由 两个 十六进制字符 组成，允许中间有 空白 存在。
- 常量串的表示也可以由 `:` 后紧接一个字符表示此字符。
- 注意当使用 `:` 表示字符时，紧接的 空白 不被忽略。
- 常量串可以通过以下操作符连接：

    - `-` : 连接操作符。 00 - FF 表示匹配从 00 到 FF 的任意值。
    - `|` : 或者操作符。 00 | FF 表示匹配 00 或者 FF 。
    - `&` : 模糊操作符。注意，这个操作符是按位模糊处理，一般用于寄存器匹配。
  
        - 处理的关键： maskA 的位与 maskB 的位相异时，即此位 0/1 都能匹配。
        - 73&70 即 0111 0011 & 0111 0000 ，匹配 70、71、72、73 。
        - 7C&71 即 0111 1100 & 0111 0001 ，匹配 70、71、74、75、78、79、7C、7D 。其效果等同于 7D&70 。
        - 半字节匹配例如 7F&70 ，全字节匹配例如 FF&00 。
        - 模糊操作符可接 `R` `L` 标记。
        - `R` 标记模糊处理 0 、 1 、 2 位。
        - `L` 标记模糊处理 3 、 4 、 5 位。

- 常量串允许通过操作符无限次连接，但请注意值冲突。

示例：

```
55 8BEC 83 10-20  # 匹配 push ebp  mov ebp, esp  sub esp, 10-20 。
:A :B             # 匹配 A 字符，匹配 B 字符，与 'AB' 同效。
B9&R              # 匹配 mov r32, xxx 。
```

---- ---- ---- ----

## 点

点相当于 00-FF 。

示例：

```
....          # 匹配四个任意值，== .{ 4 } ；== 00-FF{ 4 } 。
```

## 引用

- 引用串以 `"` 号起始， `"` 号结束。
- 引用串为 Unicode 格式时，需要在起始 `"` 前加 `L` 。
- 引用串内如果需要再包含 `"` 号，请使用 `\\"` 。
- 引用串内将 空白 视作引用串的内容
- 引用串内的 换行 与 回车 请使用 `\\r` 、 `\\n` 。支持转义字符。

```
B8 "binsig_quote"  # 相当于定位 push XXXX ， XXXX 指向 "binsig_quote" 。
```

## 范围指示

- 范围指示只能用于 [点](#点) 、 [常量串](#常量串) 、 [组合](#组合) 。
- 范围指示不能重复使用。
- 范围最小为 0 ，最大 *MAX* （x86下为 *0x7FFFFFFF* ，x64下为 *0x7FFFFFFF_FFFFFFFF* ）。
- 范围指示 **必须** 为以下几种类型：
    - `*` : 表示匹配范围从 0 到 *MAX* 。== { 0, *MAX* } == { , } 。
    - `+` : 表示匹配范围从 1 到 *MAX* 。== { 1, *MAX* } == { 1, } 。
    - `?` : 表示匹配范围从 0 到 1 。== { 0, 1 } == { ,1 } 。
    - `{ N, M}` : 表示匹配范围从 N 到 M 。
    - `{ N }` : 表示匹配范围固定为 N 。
    - `{ , M }` : 表示匹配范围从 0 到 M 。
    - `{ N, }` : 表示匹配范围从 N 到 *MAX* 。
    - `{ , }` : 表示匹配范围从 0 到 *MAX* 。== * 。
        - 注意 N 与 M 不得超过 *MAX* 。
        - N 与 M 将以十六进制识别，允许 N > M 。
        - 除分隔符外， `{ }` 间不得有除空白外的非十六进制字符，否则识别失败。
- 注意匹配模式是 **非贪婪** 的。

示例：

```
00?     # 00 匹配 0 次或 1 次。
FF{8}   # FF 匹配 8 次。
```

## 字符串

- 字符串以 `'` 号起始， `'` 号结束
- 字符串为 Unicode 格式时，需要在起始 `'` 前加 `L` 。
- 字符串如果需要再包含 `'` 号，请使用 `\'` 。
- 字符串内将 空白 视作字符串的内容。
- 字符串内的 换行 与 回车 请使用 `\r` 、 `\n` 。支持转义字符。

示例：

```
'123456789'   # 匹配字符串 123456789
```

 ## 附标记与附引用

- 附标记 由两个十六进制、`@` 符号， `L` 或  `R` 符号组成。
- 附引用 由两个十六进制、 `$` 符号， [1-F] 十六进制数索引， `L` 或 `R` 符号组成。
- 附标记 与 附引用 只标识一个十六进制数值，不能应用 [范围指示](#范围指示) 。
- 附标记 与 附引用 可以同时存在，此时，无视书写顺序，一律认为 附标记 在 附引用  之前。
- `L` 或 `R` 可以同时存在，此时，无视书写顺序，一律认为 `L` 在 `R` 之前
- 附引用 的 `$` 后十六进制数可以缺省，缺省值为 1 。
- `R` 标记模糊处理 0 、 1 、 2 位。 `L` 标记模糊处理 3 、 4 、 5 位。
    - 50@R ，匹配 50-57 。
    - C8@L ，匹配 C8-F8 。
    - 模糊匹配的相关说明参考 [常量串](#常量串) 。
- 附标记 与 附引用 匹配使用。

示例：

```
B9@R 78563412     # 匹配 B8-B7 ，附标记。
8B 11@L$2R        # 匹配 00-3F ，但低三位必须与上面标记位相同。
B9@R 78563412
8B 11$R           # 索引缺省
```


## 组合

- 组合由 `[` 号起始， `]` 号结束，内容由一个或多个 [常量串](#常量串) 组成。
- 组合的第一个非空白字符如果为 `^` ，匹配值组将被翻转。
- 除翻转操作外，组合一般可以由操作符连接的 [常量串](#常量串) 就可以完成。
- 组合内部的模糊操作符不可接 `R`  `L` 标记。
- 组合的其它条件参考 [常量串](#常量串) 说明。

示例：

```
[^0A0D]     # 匹配除 0A 、 0D 外的任意值。
```

## 额外说明

- 如果特征码串中无特征点，自动在串头部添加 <A> 。
- [特征点](#特征点) 名称 允许重名，将判定重名特征点结果是否一致。

## 特征码脚本格式说明

- 特征码 或 范围指示 用 `/` 标记起始与结束。
- 起始标记可省略；在脚本结尾，结束标记也可省略。
- 范围指示 必须使用 `@` 或 `$` 作为起始非空白字符。
    - 范围指示 为标准 PE 文件时， `@` 表示全映像， `$` 表示代码段。
    - 范围组 忽略 `@` 与 `$` 。
- 范围指示 可以指示多块。
- 范围指示 优先识别为模块，当模块不存在时，识别为 范围组。
- 范围组 必须成对出现，且不能有交集。

```
/
signature1
/
/
signature2
/

# 以上是完整的起始与结束标记

signature3
/
signature4
/
signature5
# 以上省略起始标记，省略结尾结束标记，但是合法。

@xxx.dll      # 指示一个模块。
@xxx.dll@yyy.dll@zzz.dll  # 指示多个模块。
@400000@401000            # 指示一个范围。
@400000@401000@401000@402000    # 指示多个范围。
```